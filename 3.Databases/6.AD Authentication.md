# 6.Setup Active Directory Authentication
The inventory app is onlyt for an thorised emplyee to manage the book inventory, we will use AD to secure it

Azure AD Licences<br>![Pasted image 20230516110305](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/3070fa29-60ad-4ef8-b79d-72f3509768bf)


We are going to assign managed identity to inventory app and use it to connect to azure sql db
- turn on system managed identity for ``readit-inventory-s`` to register with azure ad <br>![Pasted image 20230516112913](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/02f4b7a0-343d-4917-8e0d-acd233e58df5)

-  configure ad admin for sql server<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/a568947f-4d13-4219-834a-cccd4526e8de)

- set a user as admin<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/868099fd-7bb7-4eaa-8d7c-31b2be7d9bff)

- run sql commands against ``readit-db
	-  create a new user ang grant it read, write and admin permissions<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/d947cae1-bc37-444a-82f3-79f516ad77f3)

	- in ``readit-inventory-s`` remove credentials from connection string as we have set managed identity<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/15869368-3b40-45b7-9d85-dc40bec1ba2a)
![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/e51ba454-9136-4a87-8bb1-e7d859935cfe)

	 
	- update inventory app with AD support
	- build
	- deploy
	- test<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/426d9e09-f4fc-41f3-a02d-81c31bb328b4)

	- its working
	- configure AD authentication
	- register app in AD
	- add code to use azure ad as auth engine
	- auth uses OAuth & JWT<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/43dfa022-b030-40ae-8097-e07cb45e9a7e)


	- remove access restrictions from ``readit-inventory-s``<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/ed8a2d51-1f1a-498e-aabf-4e9e323f98b0)
	![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/6dd1269d-89dc-48b2-b0a4-0edaf9667f86)

	- register this app in azure ad<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/245a8dff-1d26-400a-af77-8dea94c2dfd1)

	- configure token<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/5731d5d0-f1f2-41cf-8848-8433d4cd9464)

	- add client secrets<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/5760b9f1-62b9-45a5-984e-0b5e83a5600c)

	- now integrate this auth in our app service
		- add identity provider<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/4e06a229-2b48-49c4-8472-8f433b39d09f)

		- make changes to the code<br>
		- publish![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/351043dc-75da-4770-b403-b6289e022cea)

		- test
			- when trying to access the website it asks for permission<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/87fe8ace-d830-4988-91c6-fb4f9c030077)

			- it successfully authenticates user<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/d396d088-c8fe-4b27-9c21-bfbb15c26661)

			- also test with other user<br>![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/e56f83f2-0fc4-45ed-9d86-86a82c3fe493)

			- this is what the token contains<br>
			![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/5c98c903-6160-4659-824b-41a34a5671d9)

			![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/722046bf-fa97-4cdc-91e8-2eb9ffdc781f)
			![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/7d9e6473-1578-45b4-9261-591fae5e00c6)


- Azure AD B2C
	![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/fa97d111-6a51-46c7-b923-3ab3dbfada5f)

	![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/328c50e6-3b21-40d6-9273-44ae1b82b6ef)

	- Quite complex to setup, so wont be using it for this app, but is an option
![download](https://github.com/salman-cissp/Deploy.WebApp.to.Azure/assets/134168108/10de5674-3b49-4ade-8083-4885ea280cf5)

